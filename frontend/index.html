<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syst√®me de R√©troaction pour l'Apprentissage</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üéì Syst√®me de R√©troaction pour l'Apprentissage</h1>
            <p class="subtitle">Modules de formation sur la migraine</p>
        </header>

        <main>
            <section class="intro-section">
                <h2>Bienvenue</h2>
                <p>
                    Ce syst√®me vous permet d'explorer vos performances dans les modules de formation
                    sur le diagnostic et le traitement de la migraine. Vous pouvez visualiser les modules
                    de formation et obtenir des retours personnalis√©s sur vos r√©ponses.
                </p>
            </section>

            <section class="objectives-section">
                <h2>üìã Objectifs d'apprentissage</h2>
                <ul class="objectives-list">
                    <li>Diff√©rencier les types de c√©phal√©es</li>
                    <li>Poser un diagnostic pertinent en contexte clinique complexe par la discrimination des caract√©ristiques cliniques de la migraine, des c√©phal√©es de tension et des c√©phal√©es m√©dicamenteuses</li>
                    <li>√âvaluer de fa√ßon critique les options th√©rapeutiques aigu√´s, pr√©ventives et hormonales dans la prise en charge des migraines</li>
                </ul>
            </section>

            <section class="trainings-section">
                <h2>üìö Modules de formation</h2>
                <div id="trainings-container" class="trainings-grid">
                    <!-- Training modules will be loaded here -->
                    <div class="loading">Chargement des modules...</div>
                </div>
            </section>

            <section class="action-section">
                <h2>üöÄ Commencer l'√©valuation</h2>
                <p>
                    Cliquez sur le bouton ci-dessous pour lancer l'√©valuation de vos r√©ponses.
                    Cela peut prendre quelques minutes.
                </p>
                <button id="start-evaluation-btn" class="primary-btn">
                    Lancer l'√©valuation
                </button>
                <div id="evaluation-status" class="status-message"></div>
            </section>
        </main>

        <footer>
            <p>&copy; 2026 Syst√®me de R√©troaction pour l'Apprentissage</p>
        </footer>
    </div>

    <!-- Modal for training content -->
    <div id="training-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modal-title"></h2>
            <div id="modal-body" class="training-content"></div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // Get API URL - either from app.js or detect it inline
        function getApiUrl() {
            // Try to get from app.js first
            if (window.API_BASE_URL) {
                console.log('‚úÖ Using API_BASE_URL from app.js:', window.API_BASE_URL);
                return window.API_BASE_URL;
            }
            
            // Fallback: detect inline (same logic as app.js)
            console.log('‚ö†Ô∏è API_BASE_URL not found, detecting inline...');
            const hostname = window.location.hostname;
            const port = window.location.port;
            const protocol = window.location.protocol;
            
            // Local development
            if (hostname === 'localhost' && port === '3000') {
                return 'http://localhost:8000';
            }
            
            // Replit - always use port 8000
            const isReplit = hostname.includes('replit.app') || 
                             hostname.includes('repl.co') || 
                             hostname.includes('replit.dev') ||
                             hostname.includes('riker.replit');
            
            if (isReplit && port && port !== '8000' && port !== '80' && port !== '443') {
                return `${protocol}//${hostname}:8000`;
            }
            
            return window.location.origin;
        }

        // Load trainings on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadTrainings();
            setupEventListeners();
        });

        async function loadTrainings() {
            const container = document.getElementById('trainings-container');
            const apiUrl = getApiUrl();

            try {
                console.log('üì° Loading trainings from:', `${apiUrl}/trainings`);
                
                const response = await fetch(`${apiUrl}/trainings`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error(`Expected JSON but got ${contentType}. The API endpoint may not be reachable.`);
                }
                
                const data = await response.json();
                const trainings = data.trainings;

                container.innerHTML = '';

                trainings.forEach((training, index) => {
                    const card = createTrainingCard(training, index + 1);
                    container.appendChild(card);
                });
                
                console.log('‚úÖ Trainings loaded successfully');
            } catch (error) {
                console.error('‚ùå Error loading trainings:', error);
                container.innerHTML = `
                    <div class="error">
                        <p>Erreur lors du chargement des modules</p>
                        <p style="font-size: 0.9em; color: #666;">
                            V√©rifiez que le serveur backend est en cours d'ex√©cution sur le port 8000.
                        </p>
                        <p style="font-size: 0.8em; color: #888;">
                            API URL: ${apiUrl}<br>
                            Erreur: ${error.message}
                        </p>
                    </div>`;
            }
        }

        function createTrainingCard(training, number) {
            const card = document.createElement('div');
            card.className = 'training-card';

            card.innerHTML = `
                <div class="training-number">Module ${number}</div>
                <h3>${training.name}</h3>
                <button class="view-btn" onclick="showTrainingModal('${training.id}', '${training.name}', \`${escapeHtml(training.content)}\`)">
                    Voir le contenu
                </button>
            `;

            return card;
        }

        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;")
                .replace(/`/g, "\\`");
        }

        function showTrainingModal(id, name, content) {
            const modal = document.getElementById('training-modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            title.textContent = name;
            body.innerHTML = `<pre>${content}</pre>`;

            modal.style.display = 'block';
        }

        function setupEventListeners() {
            // Modal close button
            const modal = document.getElementById('training-modal');
            const closeBtn = document.querySelector('.close');

            closeBtn.onclick = () => {
                modal.style.display = 'none';
            };

            window.onclick = (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            };

            // Evaluation button
            const evalBtn = document.getElementById('start-evaluation-btn');
            evalBtn.onclick = startEvaluation;
        }

        async function startEvaluation() {
            const btn = document.getElementById('start-evaluation-btn');
            const status = document.getElementById('evaluation-status');
            const apiUrl = getApiUrl();

            btn.disabled = true;
            btn.textContent = '√âvaluation en cours...';
            status.textContent = '‚è≥ √âvaluation des modules de formation...';
            status.className = 'status-message info';

            try {
                console.log('üöÄ Starting evaluation at:', `${apiUrl}/evaluate`);
                
                const response = await fetch(`${apiUrl}/evaluate`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error(`Expected JSON but got ${contentType}. The API endpoint may not be reachable.`);
                }

                const data = await response.json();

                if (data.status === 'completed') {
                    status.textContent = '‚úÖ √âvaluation termin√©e! Redirection vers le chat...';
                    status.className = 'status-message success';

                    // Store session ID and redirect to chat
                    localStorage.setItem('session_id', data.session_id);
                    setTimeout(() => {
                        window.location.href = 'chat.html';
                    }, 1500);
                }
            } catch (error) {
                console.error('‚ùå Error during evaluation:', error);
                status.innerHTML = `
                    ‚ùå Erreur lors de l'√©valuation<br>
                    <span style="font-size: 0.9em;">API URL: ${apiUrl}</span><br>
                    <span style="font-size: 0.8em;">${error.message}</span>
                `;
                status.className = 'status-message error';
                btn.disabled = false;
                btn.textContent = 'Lancer l\'√©valuation';
            }
        }
    </script>
</body>
</html>
